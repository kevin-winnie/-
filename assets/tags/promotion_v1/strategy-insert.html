<strategy-insert>

	<button type="button" class="btn btn-success" data-toggle="modal" data-target="#strategy-insert" onclick="{ amount }">添加满额优惠</button>
	<button type="button" class="btn btn-success" data-toggle="modal" data-target="#strategy-insert" onclick="{ quantity }">添加满件优惠</button>

	<!-- Modal -->
	<form class="form-horizontal" onsubmit="{ submit }">
	<div class="modal fade" id="strategy-insert" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="myModalLabel">添加优惠</h4>
				</div>	
				<div class="modal-body">
					<div class="form-group">
						<label class="col-sm-2 control-label">类型：</label>
						<div class="col-sm-4">
							<p class="form-control-static"></p>
							<input name="type" type="hidden" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">名称：</label>
						<div class="col-sm-4">
							<input name="name" type="text" class="form-control" placeholder="会对外展示" required>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">注释：</label>
						<div class="col-sm-8">
							<input name="remarks" type="text" class="form-control" placeholder="只对内展示">
						</div>
					</div>	
					<div class="form-group">
						<label class="col-sm-2 control-label">提交人：</label>
						<div class="col-sm-4">
							<input name="by" type="text" class="form-control" value="{ by }" readonly>
						</div>
					</div>	

					<div class="form-group">
						<label class="col-sm-2 control-label">开始时间：</label>
						<div class="col-sm-4">
							<input name="start" type="text" class="form-control" required>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">结束时间：</label>
						<div class="col-sm-4">
							<input name="end" type="text" class="form-control" value="{ end }" required>
						</div>
					</div>					

					<hr />

					<div class="form-group">
						<label class="col-sm-2 control-label">适用平台：</label>
						<div class="col-sm-5">
							<label class="checkbox-inline"><input name="platform[]" type="checkbox" checked="true" value="b2c">b2c</label>
							<label class="checkbox-inline"><input name="platform[]" type="checkbox" value="o2o" disabled='true'>o2o</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">适用渠道：</label>
						<div class="col-sm-5">
							<label class="checkbox-inline"><input name="channel[]" type="checkbox" checked="true" value="pc">pc</label>
							<label class="checkbox-inline"><input name="channel[]" type="checkbox" checked="true" value="wap">wap</label>
							<label class="checkbox-inline"><input name="channel[]" type="checkbox" checked="true" value="app">app</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">适用省市：</label>
						<div class="col-sm-8">
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="143949">北京</label>
							<!--<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="145874">北京五环外</label>-->
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="144005">天津</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="143983">河北</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="144443">四川</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="144522">重庆</label>							
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-2 col-sm-8">
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="106092">上海</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="145855">上海郊区</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="1">江苏</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="54351">浙江</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="106340">安徽</label>
							<label class="checkbox-inline"><input name="province[]" type="checkbox" checked="true" value="144252">广东</label>	
							<label class="checkbox-inline"><input type="checkbox" onclick="{ province_all }">全选</label>						
						</div>
					</div>	
					<div class="form-group">	
						<label class="col-sm-2 control-label">适用仓库：</label>
						<div class="col-sm-4">	
							<select name="warehouse[]" multiple class="form-control">
								<option each="{ warehouses }" value="{ id }" selected="true">{ name }</option>
							</select>							
						</div>
						<div class="col-sm-2">
							<label class="checkbox-inline"><input type="checkbox" onclick="{ warehouse_all }" checked="true">全选</label>	
						</div>						
					</div>									
					<div class="form-group">
						<label class="col-sm-2 control-label">会员等级：</label>
						<div class="col-sm-5">
							<label class="checkbox-inline"><input name="member[]" type="checkbox" checked="true" value="1">v0</label>
							<label class="checkbox-inline"><input name="member[]" type="checkbox" checked="true" value="2">v1</label>
							<label class="checkbox-inline"><input name="member[]" type="checkbox" checked="true" value="3">v2</label>
							<label class="checkbox-inline"><input name="member[]" type="checkbox" checked="true" value="4">v3</label>
							<label class="checkbox-inline"><input name="member[]" type="checkbox" checked="true" value="5">v4</label>
							<label class="checkbox-inline"><input name="member[]" type="checkbox" checked="true" value="6">v5</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">有效：</label>
						<div class="col-sm-5">
							<p class="form-control-static">否</p>
							<input name="active" type="hidden" value="false">
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label"><small>每用户只享受一次：</small></label>
						<div class="col-sm-5">
							<label class="radio-inline"><input name="enjoy_once" type="radio" disabled value="true">是</label>
							<label class="radio-inline"><input name="enjoy_once" type="radio" disabled value="false" checked>否</label>
							<input name="enjoy_once" type="hidden" value="false">
						</div>
					</div>	

					<hr />

					<div class="form-group">
						<label class="col-sm-2 control-label">适用商品：</label>
						<div class="col-sm-4">
							<label class="radio-inline"><input type="radio" name="product_all" value="true" onclick="{ product_all }">不限(全场)</label>
							<label class="radio-inline"><input type="radio" name="product_all" value="false" onclick="{ product_list }" checked>否，根据以下规则：</label>					
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-2 col-sm-8">
							<div class="input-group">
								<span class="input-group-addon">白名单</span>
								<input name="product_white" type="text" class="form-control" placeholder="product_id: 101, 102" aria-describedby="basic-addon1" required>
							</div>
						</div>
					</div>

					<hr />

					<div class="form-group">
						<label class="col-sm-2 control-label">最少满足：</label>
						<div class="col-sm-4">
							<input name="condition_min" type="text" class="form-control" placeholder="最小值(低于此数值就不享受优惠)" required>
						</div>
					</div>
					<div class="form-group" id="max">
						<label class="col-sm-2 control-label">最多满足：</label>
						<div class="col-sm-4">
							<input name="condition_max" type="text" class="form-control" placeholder="最大值(超过此数值就不享受优惠)" required>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">商品满足方式：</label>
						<div class="col-sm-8">
							<label class="radio-inline" title="购物车里有1个商品满足商品白名单算1次满足条件">
								<input name="condition_combo" type="radio" value="one" checked>单个满足
							</label>
							<label class="radio-inline" title="购物车里有n个商品满足商品白名单算1次满足条件">
								<input name="condition_combo" type="radio" value="some">任意
								<input name="condition_combo_num" type="text" placeholder="件数">件满足
							</label>
							<label class="radio-inline" title="购物车里所有商品都满足商品白名单算1次满足条件">
								<input name="condition_combo" type="radio" value="all">全部满足
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-2 control-label">可以重复优惠：</label>
						<div class="col-sm-4">
							<label class="radio-inline"><input name="condition_repeat" type="radio" value="true" checked>是</label>
							<label class="radio-inline"><input name="condition_repeat" type="radio" value="false">否</label>
						</div>
					</div>	
					
					<hr />

					<div class="form-group">
						<label class="col-sm-2 control-label">优惠类型：</label>
						<div class="col-sm-4">
							<label class="radio-inline"><input name="solution_type" type="radio" value="discount" checked onclick="{ discount }">减免</label>
							<label class="radio-inline"><input name="solution_type" type="radio" value="exchange" onclick="{ exchange }">换购</label>
							<label class="radio-inline"><input name="solution_type" type="radio" value="gift" onclick="{ gift }">赠品</label>
						</div>
					</div>			
					<div class="form-group">
						<label class="col-sm-2 control-label">减免金额：</label>
						<div class="col-sm-2">
							<input type="text" class="form-control" name="solution_reduce_money" placeholder="元" >
						</div>
					</div>
					<div class="form-group" style="display:none">
						<label class="col-sm-2 control-label">商品：</label>
						<div class="col-sm-4">
							<input type="text" name="solution_product_id" class="form-control" placeholder="product_id: 101" disabled>
						</div>
					</div>
					<div class="form-group" style="display:none">
						<label class="col-sm-2 control-label">加价金额：</label>
						<div class="col-sm-2">
							<input type="text" class="form-control" name="solution_add_money" placeholder="元" disabled>
						</div>
					</div>					
					<div class="form-group">
						<label class="col-sm-2 control-label">提醒：</label>
						<div class="col-sm-4">
							<label class="radio-inline"><input type="radio" name="solution_alert" value="true" checked>是</label>
							<label class="radio-inline"><input type="radio" name="solution_alert" value="false">否</label>
						</div>
					</div>

				</div>		

				<div class="modal-footer">
					<button class="btn btn-default" data-dismiss="modal">关闭</button>
					<button class="btn btn-primary">提交</button>
				</div>
			</div>
		</div>
	</div>
	</form>

	<script>

		var self = this;
		self.warehouses = [];

		self.on('mount', function() {
			$('#strategy-insert input[name=start]').datetimepicker({
				format:'YYYY-MM-DD HH:mm',
			});
			$('#strategy-insert input[name=end]').datetimepicker({
				format:'YYYY-MM-DD HH:mm',
			});			
			opts.getWarehouses();
		});

		opts.on('insert_strategy_done', function() {
			$('#strategy-insert').modal('hide');			
		});

		opts.on('get_warehouses_done', function(ret) {
			self.warehouses = ret;
			self.update();
		});		

		submit(e) {
			opts.insert( $(e.target).serialize() );
		}

		// input
		amount(e) {
			$('#strategy-insert').parents('form')[0].reset();
			
			var by    = $('.nav.navbar-nav.navbar-right a.dropdown-toggle').text().trim();
			var start = moment().subtract(1, 'd').format('YYYY-MM-DD HH:mm');
			var end   = moment().add(7, 'd').format('YYYY-MM-DD HH:mm');
			$('#strategy-insert input[name="by"]').val(by);
			$('#strategy-insert input[name="start"]').val(start);
			$('#strategy-insert input[name="end"]').val(end);
			$('#strategy-insert #myModalLabel').text('添加满额优惠');
			$('#strategy-insert input[name="type"]').val('amount');
			$('#strategy-insert input[name="type"]').prev().text('满额');
			$('#strategy-insert input[name="condition_min"]').parent().prev().text('最少满足金额');
			$('#strategy-insert input[name="condition_max"]').parent().prev().text('最多满足金额');
			$('#strategy-insert input[name=product_white]').attr('disabled', false);
			$('input[name=solution_reduce_money]').parents('.form-group').show();
			$('input[name=solution_reduce_money]').attr('disabled', false);
			$('input[name=solution_product_id]').parents('.form-group').hide();
			$('input[name=solution_add_money]').parents('.form-group').hide();
			$('input[name=solution_product_id]').attr('disabled', true);
			$('input[name=solution_add_money]').attr('disabled', true);			
		}
		quantity(e) {			
			$('#strategy-insert').parents('form')[0].reset();
			
			var by    = $('.nav.navbar-nav.navbar-right a.dropdown-toggle').text().trim();
			var start = moment().subtract(1, 'd').format('YYYY-MM-DD HH:mm');
			var end   = moment().add(7, 'd').format('YYYY-MM-DD HH:mm');
			$('#strategy-insert input[name="by"]').val(by);
			$('#strategy-insert input[name="start"]').val(start);
			$('#strategy-insert input[name="end"]').val(end);
			$('#strategy-insert #myModalLabel').text('添加满件优惠');
			$('#strategy-insert input[name="type"]').val('quantity');
			$('#strategy-insert input[name="type"]').prev().text('满件');
			$('#strategy-insert input[name="condition_min"]').parent().prev().text('最少满足次数');
			$('#strategy-insert input[name="condition_max"]').parent().prev().text('最多满足次数');
			$('#strategy-insert input[name=product_white]').attr('disabled', false);	
			$('input[name=solution_reduce_money]').parents('.form-group').show();
			$('input[name=solution_reduce_money]').attr('disabled', false);
			$('input[name=solution_product_id]').parents('.form-group').hide();
			$('input[name=solution_add_money]').parents('.form-group').hide();
			$('input[name=solution_product_id]').attr('disabled', true);
			$('input[name=solution_add_money]').attr('disabled', true);								
		}
		province_all(e) {
			if( $(e.target).prop('checked') )
				$('input[name="province[]"]').prop('checked', true);
			else	
				$('input[name="province[]"]').prop('checked', false);
		}	
		warehouse_all(e) {
			if( $(e.target).prop('checked') )
				$('select[name="warehouse[]"]').children().prop('selected', true)
			else	
				$('select[name="warehouse[]"]').children().prop('selected', false)		
		}		
		product_all(e) {
			$('input[name=product_white]').attr('disabled', true);
		}
		product_list(e) {
			$('input[name=product_white]').attr('disabled', false);
		}
		discount(e) {
			$('input[name=solution_reduce_money]').parents('.form-group').show();
			$('input[name=solution_reduce_money]').attr('disabled', false);
			
			$('input[name=solution_product_id]').parents('.form-group').hide();
			$('input[name=solution_add_money]').parents('.form-group').hide();
			$('input[name=solution_product_id]').attr('disabled', true);
			$('input[name=solution_add_money]').attr('disabled', true);
		}
		exchange(e) {
			$('input[name=solution_product_id]').parents('.form-group').show();
			$('input[name=solution_add_money]').parents('.form-group').show();
			$('input[name=solution_product_id]').attr('disabled', false);
			$('input[name=solution_add_money]').attr('disabled', false);
			
			$('input[name=solution_reduce_money]').parents('.form-group').hide();
			$('input[name=solution_reduce_money]').attr('disabled', true);
		}
		gift(e) {
			$('input[name=solution_product_id]').parents('.form-group').show();
			$('input[name=solution_product_id]').attr('disabled', false);
			
			$('input[name=solution_add_money]').parents('.form-group').hide();
			$('input[name=solution_reduce_money]').parents('.form-group').hide();
			$('input[name=solution_add_money]').attr('disabled', true);
			$('input[name=solution_reduce_money]').attr('disabled', true);
		}
	</script>

	<style type="text/css">
		input[name=condition_combo_num] {
			width: 35px
		}
	</style>

</strategy-insert>
